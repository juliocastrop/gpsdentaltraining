---
/**
 * Monthly Seminar Detail Page - GPS Dental Training
 * Template router: delegates rendering to Modern or Classic template
 * based on seminar.layout_template column
 */
import '../../styles/global.css';
import { getSiteSettings } from '../../lib/data/site-settings-loader';
const siteSettings = await getSiteSettings();
import { supabaseAdmin } from '../../lib/supabase/client';

// Template components
import ModernSeminarDetail from '../../components/templates/seminars/ModernSeminarDetail.astro';
import ClassicSeminarDetail from '../../components/templates/seminars/ClassicSeminarDetail.astro';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/monthly-seminars');
}

// Fetch seminar data
const { data: seminar, error: seminarError } = await supabaseAdmin
  .from('seminars')
  .select('*')
  .eq('slug', slug)
  .eq('status', 'active')
  .single();

if (seminarError || !seminar) {
  return Astro.redirect('/404');
}

// Fetch moderators/speakers for this seminar
const { data: moderatorRelations } = await supabaseAdmin
  .from('seminar_moderators')
  .select(`
    role,
    display_order,
    speaker:speakers (
      id,
      name,
      slug,
      title,
      bio,
      photo_url,
      social_links
    )
  `)
  .eq('seminar_id', seminar.id)
  .order('display_order');

const moderators = (moderatorRelations || [])
  .map((r: any) => ({ ...r.speaker, role: r.role }))
  .filter((m: any) => m !== null);

// Fetch upcoming sessions
const today = new Date().toISOString().split('T')[0];
const { data: sessions } = await supabaseAdmin
  .from('seminar_sessions')
  .select('*')
  .eq('seminar_id', seminar.id)
  .gte('session_date', today)
  .order('session_date')
  .limit(5);

// Default values for optional fields
const agendaItems = seminar.agenda_items || [
  { time: '5:45 PM - 6:00 PM', title: 'Meet and Greet', description: 'Networking and introductions' },
  { time: '6:00 PM - 7:45 PM', title: 'Main Session', description: 'Core content and discussions' },
  { time: '7:45 PM - 8:00 PM', title: 'Summary & Conclusions', description: 'Key takeaways and Q&A' },
];

const benefits = seminar.benefits || [
  'Interactive academic discussions',
  'Evidence-based clinical debates',
  'Treatment planning seminars',
  'Literature review sessions',
  'Networking with peers',
  '20 CE credits upon completion',
];

const certificateDates = seminar.certificate_dates || ['June 30', 'December 31'];

const cleanTitle = seminar.title.replace('[TEST] ', '');

// Determine which template to use
const layoutTemplate = seminar.layout_template || 'modern';

// Template props
const templateProps = {
  seminar,
  moderators,
  siteSettings,
  cleanTitle,
  agendaItems,
  benefits,
  certificateDates,
  url: Astro.url,
};
---

{layoutTemplate === 'classic' ? (
  <ClassicSeminarDetail {...templateProps} />
) : (
  <ModernSeminarDetail {...templateProps} />
)}
