---
/**
 * Monthly Seminars Main Page - GPS Dental Training
 * Template router: delegates rendering to Modern or Classic template
 * based on seminar.layout_template column
 */
import '../../styles/global.css';
import { getSiteSettings } from '../../lib/data/site-settings-loader';
const siteSettings = await getSiteSettings();
import { supabaseAdmin } from '../../lib/supabase/client';

// Template components
import ModernSeminarDetail from '../../components/templates/seminars/ModernSeminarDetail.astro';
import ClassicSeminarDetail from '../../components/templates/seminars/ClassicSeminarDetail.astro';

// Fetch the current active seminar season (current year or most recent)
const currentYear = new Date().getFullYear();
const { data: seminar, error: seminarError } = await supabaseAdmin
  .from('seminars')
  .select(`
    *,
    seminar_sessions (
      id,
      session_number,
      session_date,
      session_time_start,
      session_time_end,
      topic,
      description
    )
  `)
  .eq('status', 'active')
  .order('year', { ascending: false })
  .limit(1)
  .single();

if (seminarError) {
  console.error('Error fetching seminar:', seminarError);
}

// Fetch moderators/speakers for this seminar
let moderators: any[] = [];
if (seminar) {
  const { data: moderatorRelations } = await supabaseAdmin
    .from('seminar_moderators')
    .select(`
      role,
      display_order,
      speaker:speakers (
        id,
        name,
        slug,
        title,
        bio,
        photo_url,
        social_links
      )
    `)
    .eq('seminar_id', seminar.id)
    .order('display_order');

  moderators = (moderatorRelations || [])
    .map((r: any) => ({ ...r.speaker, role: r.role }))
    .filter((m: any) => m !== null);
}

// Sort sessions by session_number
const sessions = seminar?.seminar_sessions?.sort((a: any, b: any) => a.session_number - b.session_number) || [];

// Calculate session stats
const now = new Date();
const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
const upcomingSessions = sessions.filter((s: any) => new Date(s.session_date) >= today);
const completedSessions = sessions.filter((s: any) => new Date(s.session_date) < today);
const nextSession = upcomingSessions[0];

// Calculate next certificate date
const currentMonth = now.getMonth();
const nextCertificateDate = currentMonth < 6
  ? `June 30, ${now.getFullYear()}`
  : `December 31, ${now.getFullYear()}`;
const sessionsBeforeCertificate = upcomingSessions.filter((s: any) => {
  const sessionDate = new Date(s.session_date);
  const certDate = currentMonth < 6
    ? new Date(now.getFullYear(), 5, 30)
    : new Date(now.getFullYear(), 11, 31);
  return sessionDate <= certDate;
}).length;

// Default values for optional fields
const agendaItems = seminar?.agenda_items || [
  { time: '5:45 PM - 6:00 PM', title: 'Meet and Greet', description: 'Networking and introductions' },
  { time: '6:00 PM - 7:45 PM', title: 'Main Session', description: 'Core content and discussions' },
  { time: '7:45 PM - 8:00 PM', title: 'Summary & Conclusions', description: 'Key takeaways and Q&A' },
];

const benefits = seminar?.benefits || [
  'Interactive academic discussions',
  'Evidence-based clinical debates',
  'Treatment planning seminars',
  'Literature review sessions',
  'Networking with peers',
  '20 CE credits upon completion',
];

const certificateDates = seminar?.certificate_dates || ['June 30', 'December 31'];

const cleanTitle = seminar?.title?.replace('[TEST] ', '') || 'Monthly Seminars';

// Determine which template to use
const layoutTemplate = seminar?.layout_template || 'modern';

// Template props
const templateProps = {
  seminar,
  moderators,
  sessions,
  siteSettings,
  cleanTitle,
  agendaItems,
  benefits,
  certificateDates,
  url: Astro.url,
  // Session transparency info
  sessionStats: {
    total: sessions.length,
    completed: completedSessions.length,
    upcoming: upcomingSessions.length,
    nextSession,
    nextCertificateDate,
    sessionsBeforeCertificate,
  },
};

// Generate meta description
const metaDescription = seminar?.description
  ? seminar.description.replace(/<[^>]*>/g, '').substring(0, 160)
  : `GPS Monthly Seminars - A 10-session cycle dedicated to Literature Review, Case Discussions, and Treatment Planning. Earn 20 CE credits.`;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={metaDescription} />

    <link rel="icon" href={siteSettings.favicon_url} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url.href} />
    <meta property="og:title" content={`${cleanTitle} | GPS Dental Training`} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:image" content={seminar?.featured_image_url || '/og-default.jpg'} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${cleanTitle} | GPS Dental Training`} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={seminar?.featured_image_url || '/og-default.jpg'} />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet" />

    <title>{cleanTitle} | GPS Dental Training</title>
  </head>

  <body class="min-h-screen flex flex-col bg-white">
    {seminar ? (
      layoutTemplate === 'classic' ? (
        <ClassicSeminarDetail {...templateProps} />
      ) : (
        <ModernSeminarDetail {...templateProps} />
      )
    ) : (
      <!-- No Active Seminar Fallback -->
      <main class="flex-1 bg-[#F8F9FA] flex items-center justify-center py-20">
        <div class="text-center px-4">
          <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
          </div>
          <h1 class="text-3xl font-bold text-[#0C2044] mb-4">Monthly Seminars Coming Soon</h1>
          <p class="text-gray-600 max-w-md mx-auto mb-8">
            We're currently preparing our next seminar program. Check back soon or contact us for more information about upcoming sessions.
          </p>
          <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a
              href="/contact"
              class="inline-flex items-center justify-center gap-2 bg-[#0C2044] text-white px-8 py-4 rounded-lg font-bold hover:bg-[#173D84] transition-colors"
            >
              Contact Us
            </a>
            <a
              href="/courses"
              class="inline-flex items-center justify-center gap-2 bg-white text-[#0C2044] px-8 py-4 rounded-lg font-bold border border-gray-200 hover:bg-gray-50 transition-colors"
            >
              View Courses
            </a>
          </div>
        </div>
      </main>
    )}
  </body>
</html>
