---
/**
 * Checkout Success Page - GPS Dental Training
 * Shown after successful Stripe payment
 */
import '../../styles/global.css';
import { getSiteSettings } from '../../lib/data/site-settings-loader';
const siteSettings = await getSiteSettings();
import Navbar from '../../components/layout/Navbar';
import Footer from '../../components/layout/Footer';
import { getOrderByStripeSession } from '../../lib/supabase/queries';

// Get session_id from URL
const sessionId = Astro.url.searchParams.get('session_id');

// Fetch order details if session_id is provided
let order: any = null;
let orderItems: any[] = [];

if (sessionId) {
  try {
    order = await getOrderByStripeSession(sessionId);
    orderItems = order?.items || [];
  } catch (error) {
    console.error('Error fetching order:', error);
  }
}

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
    year: 'numeric',
  });
}

function formatPrice(price: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
  }).format(price);
}
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />

    <link rel="icon" href={siteSettings.favicon_url} />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet" />

    <title>Order Confirmed | GPS Dental Training</title>
  </head>

  <body class="min-h-screen flex flex-col bg-[#F8F9FA]">
    <Navbar
      logo={siteSettings.logo_url}
      transparent={false}
      client:load
    />

    <!-- Spacer for fixed navbar -->
    <div class="h-20"></div>

    <main class="flex-1 py-12 lg:py-16">
      <div class="container mx-auto px-4 lg:px-8 max-w-3xl">
        <!-- Success Icon & Message -->
        <div class="text-center mb-10">
          <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h1 class="text-3xl lg:text-4xl font-bold text-[#0C2044] mb-4">
            Thank You for Your Order!
          </h1>
          <p class="text-lg text-gray-600 max-w-xl mx-auto">
            Your registration has been confirmed. You will receive an email with your ticket(s) and QR code shortly.
          </p>
        </div>

        {order ? (
          <>
            <!-- Order Details Card -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
              <div class="p-6 bg-gradient-to-r from-[#0C2044] to-[#173D84] text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm text-white/70">Order Number</p>
                    <p class="text-xl font-bold">{order.order_number}</p>
                  </div>
                  <div class="text-right">
                    <p class="text-sm text-white/70">Total</p>
                    <p class="text-xl font-bold">{formatPrice(order.total)}</p>
                  </div>
                </div>
              </div>

              <!-- Order Items -->
              <div class="divide-y divide-gray-100">
                {orderItems.map((item: any) => (
                  <div class="p-6">
                    <div class="flex items-start gap-4">
                      {item.event?.featured_image_url ? (
                        <img
                          src={item.event.featured_image_url}
                          alt={item.event?.title}
                          class="w-24 h-24 rounded-lg object-cover flex-shrink-0"
                        />
                      ) : (
                        <div class="w-24 h-24 rounded-lg bg-gradient-to-br from-[#173D84] to-[#0C2044] flex items-center justify-center flex-shrink-0">
                          <svg class="w-8 h-8 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                          </svg>
                        </div>
                      )}
                      <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-[#0C2044] text-lg mb-1">
                          {item.event?.title?.replace('[TEST] ', '')}
                        </h3>
                        {item.event?.start_date && (
                          <p class="text-gray-600 mb-2">
                            <svg class="w-4 h-4 inline-block mr-1 text-[#0B52AC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            {formatDate(item.event.start_date)}
                          </p>
                        )}
                        {item.event?.venue && (
                          <p class="text-gray-500 text-sm">
                            <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                            {item.event.venue}
                          </p>
                        )}
                        <div class="flex items-center gap-4 mt-3">
                          <span class="text-sm text-gray-500">
                            {item.ticket_type?.name} Ã— {item.quantity}
                          </span>
                          <span class="font-semibold text-[#0C2044]">
                            {formatPrice(item.total)}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              <!-- Order Summary -->
              <div class="p-6 bg-gray-50 border-t border-gray-100">
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Subtotal</span>
                  <span class="font-medium">{formatPrice(order.subtotal)}</span>
                </div>
                {order.discount > 0 && (
                  <div class="flex justify-between items-center mt-2 text-green-600">
                    <span>Discount</span>
                    <span class="font-medium">-{formatPrice(order.discount)}</span>
                  </div>
                )}
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
                  <span class="font-bold text-[#0C2044] text-lg">Total Paid</span>
                  <span class="font-bold text-[#0C2044] text-lg">{formatPrice(order.total)}</span>
                </div>
              </div>
            </div>

            <!-- Email Notice -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
              <div class="flex items-start gap-4">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-semibold text-blue-900 mb-1">Check Your Email</h3>
                  <p class="text-blue-700 text-sm">
                    A confirmation email with your ticket(s) and QR code has been sent to <strong>{order.billing_email}</strong>.
                    Please bring your QR code to the event for check-in.
                  </p>
                </div>
              </div>
            </div>
          </>
        ) : (
          <!-- No Order Found -->
          <div class="bg-white rounded-xl shadow-sm p-8 text-center mb-8">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-[#0C2044] mb-2">Order Processing</h3>
            <p class="text-gray-600 mb-4">
              Your payment is being processed. You will receive a confirmation email shortly.
            </p>
          </div>
        )}

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="/account/tickets"
            class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-[#0B52AC] text-white font-semibold rounded-lg hover:bg-[#0C2044] transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
            </svg>
            View My Tickets
          </a>
          <a
            href="/courses"
            class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-white text-[#0C2044] font-semibold rounded-lg border border-gray-200 hover:border-[#0C2044] transition-colors"
          >
            Browse More Courses
          </a>
        </div>

        <!-- What's Next Section -->
        <div class="mt-12 bg-white rounded-xl shadow-sm overflow-hidden">
          <div class="p-6 border-b border-gray-100">
            <h2 class="text-xl font-bold text-[#0C2044]">What's Next?</h2>
          </div>
          <div class="p-6 grid sm:grid-cols-3 gap-6">
            <div class="text-center">
              <div class="w-12 h-12 bg-[#DDC89D]/20 rounded-lg flex items-center justify-center mx-auto mb-3">
                <svg class="w-6 h-6 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
              </div>
              <h3 class="font-semibold text-[#0C2044] mb-1">1. Check Email</h3>
              <p class="text-sm text-gray-500">
                Your ticket with QR code will arrive in your inbox.
              </p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-[#0B52AC]/10 rounded-lg flex items-center justify-center mx-auto mb-3">
                <svg class="w-6 h-6 text-[#0B52AC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
              <h3 class="font-semibold text-[#0C2044] mb-1">2. Add to Calendar</h3>
              <p class="text-sm text-gray-500">
                Save the date so you don't miss the event.
              </p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
              </div>
              <h3 class="font-semibold text-[#0C2044] mb-1">3. Attend & Learn</h3>
              <p class="text-sm text-gray-500">
                Show your QR code at check-in and enjoy the course!
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <Footer client:load />
  </body>
</html>
