---
/**
 * Admin Events List - GPS Dental Training
 * List all events with filtering, search, and quick actions
 */
import AdminLayout from '../../../layouts/AdminLayout.astro';
import EventsList from '../../../components/admin/EventsList';
import { supabaseAdmin } from '../../../lib/supabase/client';

// Check if Clerk is configured
const clerkConfigured = !!import.meta.env.PUBLIC_CLERK_PUBLISHABLE_KEY;

// Get user from Clerk if available
let userId: string | null = null;
let isAdmin = false;
let userName = 'Admin';
let userEmail = 'admin@gpsdentaltraining.com';

try {
  if (clerkConfigured && Astro.locals.auth) {
    const auth = Astro.locals.auth();
    userId = auth?.userId || null;

    if (userId) {
      const { data: userData } = await supabaseAdmin
        .from('users')
        .select('role, first_name, last_name, email')
        .eq('clerk_id', userId)
        .single();

      isAdmin = userData?.role === 'admin';
      if (userData?.first_name) {
        userName = `${userData.first_name} ${userData.last_name || ''}`.trim();
      }
      if (userData?.email) {
        userEmail = userData.email;
      }
    }
  }
} catch {
  isAdmin = true;
}

if (clerkConfigured && (!userId || !isAdmin)) {
  return Astro.redirect('/sign-in?redirect_url=/admin/events');
}

// Fetch events
let events: any[] = [];

try {
  const { data: eventsData } = await supabaseAdmin
    .from('events')
    .select(`
      id,
      title,
      start_date,
      end_date,
      venue,
      capacity,
      ce_credits
    `)
    .order('start_date', { ascending: false });

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  for (const event of eventsData || []) {
    // Get ticket count
    const { count: ticketsSold } = await supabaseAdmin
      .from('tickets')
      .select('*', { count: 'exact', head: true })
      .eq('event_id', event.id)
      .eq('status', 'valid');

    // Get attendance count
    const { count: checkedIn } = await supabaseAdmin
      .from('attendance')
      .select('*', { count: 'exact', head: true })
      .eq('event_id', event.id);

    // Determine status
    const startDate = new Date(event.start_date);
    const endDate = event.end_date ? new Date(event.end_date) : startDate;
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);

    let status: 'upcoming' | 'ongoing' | 'past' = 'upcoming';
    if (today > endDate) {
      status = 'past';
    } else if (today >= startDate && today <= endDate) {
      status = 'ongoing';
    }

    events.push({
      ...event,
      ticketsSold: ticketsSold || 0,
      checkedIn: checkedIn || 0,
      status,
    });
  }
} catch (error) {
  console.error('Error fetching events:', error);
}

const currentPath = Astro.url.pathname;
---

<AdminLayout title="Events">
  <EventsList
    client:load
    currentPath={currentPath}
    user={{ name: userName, email: userEmail }}
    events={events}
  />
</AdminLayout>
