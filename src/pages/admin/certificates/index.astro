---
/**
 * Admin Course Certificates - GPS Dental Training
 * Generate and manage certificates for course attendees
 */
import AdminLayout from '../../../layouts/AdminLayout.astro';
import CourseCertificates from '../../../components/admin/CourseCertificates';
import { supabaseAdmin } from '../../../lib/supabase/client';

// Check if Clerk is configured
const clerkConfigured = !!import.meta.env.PUBLIC_CLERK_PUBLISHABLE_KEY;

// Get user from Clerk if available
let userId: string | null = null;
let isAdmin = false;
let userName = 'Admin';
let userEmail = 'admin@gpsdentaltraining.com';

try {
  if (clerkConfigured && Astro.locals.auth) {
    const auth = Astro.locals.auth();
    userId = auth?.userId || null;

    if (userId) {
      const { data: userData } = await supabaseAdmin
        .from('users')
        .select('role, first_name, last_name, email')
        .eq('clerk_id', userId)
        .single();

      isAdmin = userData?.role === 'admin';
      if (userData?.first_name) {
        userName = `${userData.first_name} ${userData.last_name || ''}`.trim();
      }
      if (userData?.email) {
        userEmail = userData.email;
      }
    }
  }
} catch {
  isAdmin = true;
}

if (clerkConfigured && (!userId || !isAdmin)) {
  return Astro.redirect('/sign-in?redirect_url=/admin/certificates');
}

// Get filter params
const eventFilter = Astro.url.searchParams.get('event_id') || '';

// Fetch past events (events that have ended)
const today = new Date().toISOString().split('T')[0];
const { data: events } = await supabaseAdmin
  .from('events')
  .select('id, title, slug, start_date, end_date, ce_credits, venue')
  .eq('status', 'published')
  .lte('start_date', today)
  .order('start_date', { ascending: false })
  .limit(50);

// Fetch attendees with check-in for selected event
let attendees: any[] = [];
if (eventFilter) {
  // Get all tickets with attendance (checked-in) for this event
  const { data: attendanceData } = await supabaseAdmin
    .from('attendance')
    .select(`
      id,
      checked_in_at,
      check_in_method,
      ticket:ticket_id(
        id,
        ticket_code,
        attendee_name,
        attendee_email,
        user_id
      )
    `)
    .eq('event_id', eventFilter)
    .order('checked_in_at', { ascending: false });

  // For each attendee, check if certificate exists
  attendees = await Promise.all(
    (attendanceData || []).map(async (att) => {
      const { data: certData } = await supabaseAdmin
        .from('certificates')
        .select('id, certificate_code, pdf_url, generated_at, sent_at')
        .eq('ticket_id', att.ticket?.id)
        .single();

      return {
        attendance_id: att.id,
        ticket_id: att.ticket?.id,
        ticket_code: att.ticket?.ticket_code,
        attendee_name: att.ticket?.attendee_name,
        attendee_email: att.ticket?.attendee_email,
        user_id: att.ticket?.user_id,
        checked_in_at: att.checked_in_at,
        check_in_method: att.check_in_method,
        certificate: certData || null,
      };
    })
  );
}

// Get selected event details
let selectedEvent = null;
if (eventFilter) {
  const { data: eventData } = await supabaseAdmin
    .from('events')
    .select('*')
    .eq('id', eventFilter)
    .single();
  selectedEvent = eventData;
}

// Calculate stats
const totalAttendees = attendees.length;
const withCertificate = attendees.filter(a => a.certificate).length;
const sentCount = attendees.filter(a => a.certificate?.sent_at).length;

const currentPath = Astro.url.pathname;
---

<AdminLayout title="Course Certificates">
  <CourseCertificates
    client:load
    currentPath={currentPath}
    user={{ name: userName, email: userEmail }}
    attendees={attendees}
    events={events || []}
    eventFilter={eventFilter}
    selectedEvent={selectedEvent}
    stats={{
      total: totalAttendees,
      withCertificate,
      sent: sentCount,
    }}
  />
</AdminLayout>
