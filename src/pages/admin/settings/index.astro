---
/**
 * Admin General Settings - GPS Dental Training
 * Configure company info, contact details, notifications, and business settings
 */
import AdminLayout from '../../../layouts/AdminLayout.astro';
import GeneralSettings from '../../../components/admin/GeneralSettings';
import { supabaseAdmin } from '../../../lib/supabase/client';

// Check if Clerk is configured
const clerkConfigured = !!import.meta.env.PUBLIC_CLERK_PUBLISHABLE_KEY;

// Get user from Clerk if available
let userId: string | null = null;
let isAdmin = false;
let userName = 'Admin';
let userEmail = 'admin@gpsdentaltraining.com';

try {
  if (clerkConfigured && Astro.locals.auth) {
    const auth = Astro.locals.auth();
    userId = auth?.userId || null;

    if (userId) {
      const { data: userData } = await supabaseAdmin
        .from('users')
        .select('role, first_name, last_name, email')
        .eq('clerk_id', userId)
        .single();

      isAdmin = userData?.role === 'admin';
      if (userData?.first_name) {
        userName = `${userData.first_name} ${userData.last_name || ''}`.trim();
      }
      if (userData?.email) {
        userEmail = userData.email;
      }
    }
  }
} catch {
  isAdmin = true;
}

if (clerkConfigured && (!userId || !isAdmin)) {
  return Astro.redirect('/sign-in?redirect_url=/admin/settings');
}

// Get current general settings from database
const { data: settingsData } = await supabaseAdmin
  .from('site_settings')
  .select('*')
  .eq('key', 'general_settings')
  .single();

const defaultSettings = {
  // Company Info
  company_name: 'GPS Dental Training',
  company_legal_name: '',
  logo_url: '',
  logo_white_url: '',
  favicon_url: '',
  website_url: 'https://gpsdentaltraining.com',

  // Contact
  address_line_1: '6320 Sugarloaf Parkway',
  address_line_2: '',
  city: 'Duluth',
  state: 'GA',
  zip: '30097',
  phone: '(770) 962-2480',
  email: 'info@gpsdentaltraining.com',

  // Social Media
  facebook_url: 'https://www.facebook.com/gpsdentaltraining',
  instagram_url: 'https://www.instagram.com/gpsdentaltraining',
  linkedin_url: '',
  twitter_url: '',
  vimeo_url: '',
  youtube_url: '',

  // Notifications
  admin_emails: 'info@gpsdentaltraining.com\njuliocastro@thewebminds.agency',
  notification_order: true,
  notification_registration: true,
  notification_waitlist: true,
  notification_checkin: false,

  // Business
  timezone: 'America/New_York',
  currency: 'USD',
  ce_provider_name: 'GPS Dental Training',
  ce_provider_id: '',
  default_event_capacity: 100,
  waitlist_expiration_hours: 48,
};

// Merge defaults with DB values so new fields get proper defaults
const currentSettings = { ...defaultSettings, ...(settingsData?.value || {}) };

const currentPath = Astro.url.pathname;
---

<AdminLayout title="General Settings">
  <GeneralSettings
    client:load
    currentPath={currentPath}
    user={{ name: userName, email: userEmail }}
    settings={currentSettings}
  />
</AdminLayout>
