---
/**
 * Monthly Seminars Page - GPS Dental Training
 * Shows user's seminar registrations and session progress
 */
import '../../styles/global.css';
import Navbar from '../../components/layout/Navbar';
import Footer from '../../components/layout/Footer';
import { supabaseAdmin } from '../../lib/supabase/client';
import { getUserSeminarRegistrations } from '../../lib/supabase/queries';

// Check if Clerk is configured
const clerkConfigured = !!process.env.PUBLIC_CLERK_PUBLISHABLE_KEY;

// Get user from Clerk if available
let userId: string | null = null;
try {
  if (clerkConfigured && Astro.locals.auth) {
    const auth = Astro.locals.auth();
    userId = auth?.userId || null;
  }
} catch {
  // Clerk not available
}

// Redirect if Clerk is configured but user is not logged in
if (clerkConfigured && !userId) {
  return Astro.redirect('/sign-in?redirect_url=/account/seminars');
}

// Initialize variables
let user: any = null;
let registrations: any[] = [];

// Fetch data if user is logged in
if (userId) {
  // Get user from Supabase
  const { data: userData } = await supabaseAdmin
    .from('users')
    .select('*')
    .eq('clerk_id', userId)
    .single();
  user = userData;

  if (user) {
    try {
      registrations = await getUserSeminarRegistrations(user.id);
    } catch (error) {
      console.error('Error fetching seminar registrations:', error);
    }
  }
}

// Separate active and completed registrations
const activeRegistrations = registrations.filter(r => r.status === 'active');
const completedRegistrations = registrations.filter(r => r.status === 'completed');

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });
}

function getStatusBadge(status: string): { bg: string; text: string; label: string } {
  switch (status) {
    case 'active':
      return { bg: 'bg-green-100', text: 'text-green-700', label: 'Active' };
    case 'completed':
      return { bg: 'bg-blue-100', text: 'text-blue-700', label: 'Completed' };
    case 'on_hold':
      return { bg: 'bg-yellow-100', text: 'text-yellow-700', label: 'On Hold' };
    case 'cancelled':
      return { bg: 'bg-red-100', text: 'text-red-700', label: 'Cancelled' };
    default:
      return { bg: 'bg-gray-100', text: 'text-gray-700', label: status };
  }
}

function calculateProgress(completed: number, total: number = 10): number {
  return Math.round((completed / total) * 100);
}
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet" />

    <title>Monthly Seminars | GPS Dental Training</title>
  </head>

  <body class="min-h-screen flex flex-col bg-[#F8F9FA]">
    <Navbar
      logo="/logo.svg"
      transparent={false}
      client:load
    />

    <!-- Spacer for fixed navbar -->
    <div class="h-20"></div>

    <main class="flex-1 py-8 lg:py-12">
      <div class="container mx-auto px-4 lg:px-8 max-w-5xl">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
          <a href="/account" class="hover:text-[#0B52AC] transition-colors">My Account</a>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
          <span class="text-[#0C2044] font-medium">Monthly Seminars</span>
        </nav>

        <!-- Header -->
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-8">
          <div>
            <h1 class="text-3xl font-bold text-[#0C2044] mb-2">Monthly Seminars</h1>
            <p class="text-gray-600">
              Track your seminar progress and session attendance.
            </p>
          </div>
        </div>

        <!-- Active Registrations -->
        {activeRegistrations.length > 0 && (
          <div class="mb-10">
            <h2 class="text-xl font-bold text-[#0C2044] mb-4 flex items-center gap-2">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              Active Memberships
            </h2>
            <div class="space-y-6">
              {activeRegistrations.map((registration: any) => {
                const status = getStatusBadge(registration.status);
                const progress = calculateProgress(registration.sessions_completed);
                const totalSessions = registration.seminar?.total_sessions || 10;
                const creditsEarned = registration.sessions_completed * 2;
                const creditsRemaining = registration.sessions_remaining * 2;

                return (
                  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <!-- Header -->
                    <div class="p-6 border-b border-gray-100 bg-gradient-to-r from-[#DDC89D]/10 to-transparent">
                      <div class="flex flex-wrap items-center justify-between gap-4">
                        <div>
                          <span class={`inline-block px-2 py-1 rounded text-xs font-semibold ${status.bg} ${status.text} mb-2`}>
                            {status.label}
                          </span>
                          <h3 class="font-bold text-[#0C2044] text-xl">
                            {registration.seminar?.title || 'GPS Monthly Seminars'}
                          </h3>
                          <p class="text-gray-500 text-sm mt-1">
                            Enrolled: {formatDate(registration.registration_date || registration.created_at)}
                          </p>
                        </div>
                        {registration.qr_code_url && (
                          <img
                            src={registration.qr_code_url}
                            alt="QR Code"
                            class="w-20 h-20 border border-gray-200 rounded-lg"
                          />
                        )}
                      </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="p-6">
                      <!-- Progress Bar -->
                      <div class="mb-6">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-sm font-medium text-gray-600">Session Progress</span>
                          <span class="text-sm font-bold text-[#0C2044]">
                            {registration.sessions_completed} / {totalSessions} sessions
                          </span>
                        </div>
                        <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
                          <div
                            class="h-full bg-gradient-to-r from-[#DDC89D] to-[#BFAC87] rounded-full transition-all duration-500"
                            style={`width: ${progress}%`}
                          ></div>
                        </div>
                      </div>

                      <!-- Stats Grid -->
                      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                          <p class="text-2xl font-bold text-green-600">{registration.sessions_completed}</p>
                          <p class="text-xs text-gray-500">Completed</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                          <p class="text-2xl font-bold text-[#0B52AC]">{registration.sessions_remaining}</p>
                          <p class="text-xs text-gray-500">Remaining</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                          <p class="text-2xl font-bold text-[#DDC89D]">{creditsEarned}</p>
                          <p class="text-xs text-gray-500">CE Earned</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                          <p class="text-2xl font-bold text-gray-400">{registration.makeup_used ? '0' : '1'}</p>
                          <p class="text-xs text-gray-500">Makeup Left</p>
                        </div>
                      </div>

                      <!-- Attendance History -->
                      {registration.attendance && registration.attendance.length > 0 && (
                        <div class="mt-6">
                          <h4 class="font-semibold text-[#0C2044] mb-3">Attendance History</h4>
                          <div class="space-y-2">
                            {registration.attendance.slice(0, 5).map((record: any) => (
                              <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                                <div class="flex items-center gap-3">
                                  <div class={`w-2 h-2 rounded-full ${record.attended ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                  <span class="text-sm text-gray-700">
                                    Session {record.session?.session_number || '?'}
                                    {record.session?.topic && `: ${record.session.topic}`}
                                  </span>
                                  {record.is_makeup && (
                                    <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded font-medium">
                                      Makeup
                                    </span>
                                  )}
                                </div>
                                <div class="flex items-center gap-4">
                                  <span class="text-xs text-gray-500">
                                    {formatDate(record.checked_in_at)}
                                  </span>
                                  <span class="text-sm font-medium text-[#DDC89D]">
                                    +{record.credits_awarded} CE
                                  </span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        <!-- Completed Registrations -->
        {completedRegistrations.length > 0 && (
          <div>
            <h2 class="text-xl font-bold text-[#0C2044] mb-4 flex items-center gap-2">
              <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
              Completed Programs
            </h2>
            <div class="space-y-4">
              {completedRegistrations.map((registration: any) => {
                const status = getStatusBadge(registration.status);
                return (
                  <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between">
                      <div>
                        <span class={`inline-block px-2 py-1 rounded text-xs font-semibold ${status.bg} ${status.text} mb-2`}>
                          {status.label}
                        </span>
                        <h3 class="font-semibold text-[#0C2044]">
                          {registration.seminar?.title || 'GPS Monthly Seminars'}
                        </h3>
                        <p class="text-sm text-gray-500">
                          {registration.seminar?.year || new Date(registration.created_at).getFullYear()}
                          • {registration.sessions_completed} sessions • {registration.sessions_completed * 2} CE Credits
                        </p>
                      </div>
                      <a
                        href="/account/certificates"
                        class="text-[#0B52AC] text-sm font-semibold hover:underline"
                      >
                        View Certificate →
                      </a>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        <!-- Empty State -->
        {registrations.length === 0 && (
          <div class="bg-white rounded-xl shadow-sm p-12 text-center">
            <div class="w-20 h-20 bg-[#DDC89D]/20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-[#0C2044] mb-2">No Seminar Memberships</h3>
            <p class="text-gray-500 mb-6 max-w-md mx-auto">
              Join our monthly seminar program to participate in 10 sessions of case discussions,
              literature reviews, and treatment planning seminars.
            </p>
            <a
              href="/monthly-seminars"
              class="inline-flex items-center gap-2 px-6 py-3 bg-[#DDC89D] text-[#0C2044] font-semibold rounded-lg hover:bg-[#BFAC87] transition-colors"
            >
              Learn About Seminars
            </a>
          </div>
        )}

        <!-- Program Info -->
        <div class="mt-8 bg-gradient-to-r from-[#0C2044] to-[#173D84] rounded-xl p-6 lg:p-8 text-white">
          <div class="flex flex-col lg:flex-row items-start gap-6">
            <div class="w-16 h-16 bg-white/10 rounded-xl flex items-center justify-center flex-shrink-0">
              <svg class="w-8 h-8 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-xl font-bold mb-2">Program Benefits</h3>
              <ul class="text-white/80 space-y-2 text-sm">
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  10 monthly sessions with 2 CE credits each (20 total)
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Literature reviews, case discussions, and treatment planning
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  One makeup session allowed per calendar year
                </li>
                <li class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Bi-annual certificates issued in June and December
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>

    <Footer client:load />
  </body>
</html>
