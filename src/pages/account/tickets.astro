---
/**
 * My Tickets Page - GPS Dental Training
 * Shows user's tickets with QR codes for check-in
 */
import '../../styles/global.css';
import Navbar from '../../components/layout/Navbar';
import Footer from '../../components/layout/Footer';
import { supabaseAdmin } from '../../lib/supabase/client';
import { getUserTickets } from '../../lib/supabase/queries';

// Check if Clerk is configured
const clerkConfigured = !!process.env.PUBLIC_CLERK_PUBLISHABLE_KEY;

// Get user from Clerk if available
let userId: string | null = null;
try {
  if (clerkConfigured && Astro.locals.auth) {
    const auth = Astro.locals.auth();
    userId = auth?.userId || null;
  }
} catch {
  // Clerk not available
}

// Redirect if Clerk is configured but user is not logged in
if (clerkConfigured && !userId) {
  return Astro.redirect('/sign-in?redirect_url=/account/tickets');
}

// Initialize variables
let user: any = null;
let tickets: any[] = [];

// Fetch data if user is logged in
if (userId) {
  // Get user from Supabase
  const { data: userData } = await supabaseAdmin
    .from('users')
    .select('*')
    .eq('clerk_id', userId)
    .single();
  user = userData;

  if (user) {
    try {
      tickets = await getUserTickets(user.id);
    } catch (error) {
      console.error('Error fetching tickets:', error);
    }
  }
}

// Separate upcoming and past tickets
const now = new Date();
const upcomingTickets = tickets.filter(t => {
  if (!t.event?.start_date) return t.status === 'valid';
  return new Date(t.event.start_date) >= now && t.status === 'valid';
});
const pastTickets = tickets.filter(t => {
  if (!t.event?.start_date) return t.status !== 'valid';
  return new Date(t.event.start_date) < now || t.status !== 'valid';
});

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('en-US', {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });
}

function formatTime(dateStr: string): string {
  return new Date(dateStr).toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
  });
}

function getStatusBadge(status: string): { bg: string; text: string; label: string } {
  switch (status) {
    case 'valid':
      return { bg: 'bg-green-100', text: 'text-green-700', label: 'Valid' };
    case 'used':
      return { bg: 'bg-blue-100', text: 'text-blue-700', label: 'Used' };
    case 'cancelled':
      return { bg: 'bg-red-100', text: 'text-red-700', label: 'Cancelled' };
    case 'expired':
      return { bg: 'bg-gray-100', text: 'text-gray-700', label: 'Expired' };
    default:
      return { bg: 'bg-gray-100', text: 'text-gray-700', label: status };
  }
}
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet" />

    <title>My Tickets | GPS Dental Training</title>
  </head>

  <body class="min-h-screen flex flex-col bg-[#F8F9FA]">
    <Navbar
      logo="/logo.svg"
      transparent={false}
      client:load
    />

    <!-- Spacer for fixed navbar -->
    <div class="h-20"></div>

    <main class="flex-1 py-8 lg:py-12">
      <div class="container mx-auto px-4 lg:px-8 max-w-5xl">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-sm text-gray-500 mb-6">
          <a href="/account" class="hover:text-[#0B52AC] transition-colors">My Account</a>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
          <span class="text-[#0C2044] font-medium">My Tickets</span>
        </nav>

        <!-- Header -->
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-8">
          <div>
            <h1 class="text-3xl font-bold text-[#0C2044] mb-2">My Tickets</h1>
            <p class="text-gray-600">
              View your tickets and QR codes for event check-in.
            </p>
          </div>
        </div>

        <!-- Upcoming Tickets -->
        {upcomingTickets.length > 0 && (
          <div class="mb-10">
            <h2 class="text-xl font-bold text-[#0C2044] mb-4 flex items-center gap-2">
              <span class="w-2 h-2 bg-green-500 rounded-full"></span>
              Upcoming Events ({upcomingTickets.length})
            </h2>
            <div class="grid gap-4">
              {upcomingTickets.map((ticket: any) => {
                const status = getStatusBadge(ticket.status);
                return (
                  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="flex flex-col lg:flex-row">
                      <!-- Event Image -->
                      <div class="lg:w-48 flex-shrink-0">
                        {ticket.event?.featured_image_url ? (
                          <img
                            src={ticket.event.featured_image_url}
                            alt={ticket.event?.title}
                            class="w-full h-32 lg:h-full object-cover"
                          />
                        ) : (
                          <div class="w-full h-32 lg:h-full bg-gradient-to-br from-[#173D84] to-[#0C2044] flex items-center justify-center">
                            <svg class="w-12 h-12 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                            </svg>
                          </div>
                        )}
                      </div>

                      <!-- Ticket Info -->
                      <div class="flex-1 p-6">
                        <div class="flex items-start justify-between gap-4 mb-3">
                          <div>
                            <span class={`inline-block px-2 py-1 rounded text-xs font-semibold ${status.bg} ${status.text} mb-2`}>
                              {status.label}
                            </span>
                            <h3 class="font-bold text-[#0C2044] text-lg">
                              <a href={`/courses/${ticket.event?.slug}`} class="hover:text-[#0B52AC] transition-colors">
                                {ticket.event?.title?.replace('[TEST] ', '')}
                              </a>
                            </h3>
                          </div>
                        </div>

                        <div class="grid sm:grid-cols-2 gap-4 text-sm">
                          <div class="flex items-center gap-2 text-gray-600">
                            <svg class="w-4 h-4 text-[#0B52AC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            {ticket.event?.start_date && formatDate(ticket.event.start_date)}
                          </div>
                          {ticket.event?.venue && (
                            <div class="flex items-center gap-2 text-gray-600">
                              <svg class="w-4 h-4 text-[#0B52AC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                              </svg>
                              {ticket.event.venue}
                            </div>
                          )}
                          <div class="flex items-center gap-2 text-gray-600">
                            <svg class="w-4 h-4 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                            </svg>
                            {ticket.ticket_type?.name || 'General Admission'}
                          </div>
                          <div class="flex items-center gap-2 text-gray-600">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                            </svg>
                            <span class="font-mono text-xs">{ticket.ticket_code}</span>
                          </div>
                        </div>
                      </div>

                      <!-- QR Code Section -->
                      <div class="lg:w-48 p-6 bg-gray-50 border-t lg:border-t-0 lg:border-l border-gray-100 flex flex-col items-center justify-center">
                        {ticket.qr_code_url ? (
                          <img
                            src={ticket.qr_code_url}
                            alt="QR Code"
                            class="w-32 h-32 mb-2"
                          />
                        ) : (
                          <div class="w-32 h-32 bg-white border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center mb-2">
                            <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                            </svg>
                          </div>
                        )}
                        <p class="text-xs text-gray-500 text-center">
                          Show at check-in
                        </p>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        <!-- Past Tickets -->
        {pastTickets.length > 0 && (
          <div>
            <h2 class="text-xl font-bold text-[#0C2044] mb-4 flex items-center gap-2">
              <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
              Past Tickets ({pastTickets.length})
            </h2>
            <div class="space-y-4">
              {pastTickets.map((ticket: any) => {
                const status = getStatusBadge(ticket.status);
                return (
                  <div class="bg-white rounded-xl shadow-sm p-6 opacity-75">
                    <div class="flex items-center gap-4">
                      {ticket.event?.featured_image_url ? (
                        <img
                          src={ticket.event.featured_image_url}
                          alt={ticket.event?.title}
                          class="w-16 h-16 rounded-lg object-cover flex-shrink-0 grayscale"
                        />
                      ) : (
                        <div class="w-16 h-16 rounded-lg bg-gray-200 flex items-center justify-center flex-shrink-0">
                          <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                          </svg>
                        </div>
                      )}
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                          <span class={`px-2 py-0.5 rounded text-xs font-semibold ${status.bg} ${status.text}`}>
                            {status.label}
                          </span>
                        </div>
                        <h3 class="font-semibold text-[#0C2044] truncate">
                          {ticket.event?.title?.replace('[TEST] ', '')}
                        </h3>
                        <p class="text-sm text-gray-500">
                          {ticket.event?.start_date && formatDate(ticket.event.start_date)}
                          {ticket.ticket_type?.name && ` â€¢ ${ticket.ticket_type.name}`}
                        </p>
                      </div>
                      <div class="text-right">
                        <p class="font-mono text-xs text-gray-400">{ticket.ticket_code}</p>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        <!-- Empty State -->
        {tickets.length === 0 && (
          <div class="bg-white rounded-xl shadow-sm p-12 text-center">
            <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-[#0C2044] mb-2">No Tickets Yet</h3>
            <p class="text-gray-500 mb-6 max-w-md mx-auto">
              You don't have any tickets yet. Register for a course to receive your ticket with QR code.
            </p>
            <a
              href="/courses"
              class="inline-flex items-center gap-2 px-6 py-3 bg-[#0B52AC] text-white font-semibold rounded-lg hover:bg-[#0C2044] transition-colors"
            >
              Browse Courses
            </a>
          </div>
        )}

        <!-- Info Card -->
        <div class="mt-8 bg-gradient-to-r from-[#0C2044] to-[#173D84] rounded-xl p-6 text-white">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-white/10 rounded-lg flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-[#DDC89D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div>
              <h3 class="font-bold text-lg mb-2">Check-in Instructions</h3>
              <p class="text-white/80 text-sm">
                Present your QR code at the registration desk when you arrive at the event.
                You can show it directly from this page or from the email confirmation you received.
                Make sure your device brightness is high for easy scanning.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <Footer client:load />
  </body>
</html>
